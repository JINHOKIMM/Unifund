<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC   "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd"
>
<!-- 이 xml 은 어떤 interface 를 참조해서 사용해야 하는가? -->
<mapper namespace="com.uni.fund.project.dao.ProjectDAO">
	<select id="detail" resultType="com.uni.fund.project.dto.ProjectDTO">
		select
			* 	
			,(select cate_name from category 
				where 
					cate_idx = (select cate_idx from project where pro_idx = 7)) as category
			,(select mem_id from member where mem_idx = (select mem_idx from project where pro_idx = 7)) as userId
			,(select COUNT(pro_idx) from project_like where pro_idx = 7 group by pro_idx) as like_cnt
			,(select SUM(a.total) from 
				(select total_price as total from project_apply where pro_idx = 7 order by mem_idx,fund_idx desc limit 1) a) as now_price
			,(select (rew_price * rew_max) from project p where pro_idx = 7) as target_price
			,(select mem_mileage from member where mem_idx = #{param1}) as mileage
			,(select mem_cash from member where mem_idx = #{param1}) as cash
			,(select mem_post from member where mem_idx =#{param1}) as mem_post 
			,(select mem_addr from member where mem_idx =#{param1}) as mem_addr 
			,(select mem_detail from member where mem_idx =#{param1}) as mem_detail
			,(select round((now_price/target_price) * 100)) as progress 
			,(select pho_name from photo where ref_idx = 7 and pho_division = '프로젝트') as pro_img_name
			,(select fund_state from project_apply where mem_idx = #{param1} and pro_idx = 7 order by fund_idx desc limit 1) as fund_state
			,(select pho_name from photo where ref_idx = #{param1} and pho_division = '프로필') as profile
			,(select mem_idx from project_like where pro_idx = 7 and mem_idx = #{param1}) as like_mem_idx
			,(select mem_idx from bookmark where pro_idx = 7 and mem_idx = #{param1}) as favorite_mem_idx
		from project where pro_idx = 7;
	</select>
	
	<insert id="projectCreate"
		useGeneratedKeys="true" 
		keyColumn="pro_idx" 
		keyProperty="pro_idx"
		parameterType= "com.uni.fund.project.dto.ProjectDTO">
		INSERT INTO project(mem_idx,cate_idx,pro_title,pro_content,pro_deadline,pro_startdate,rew_name,ori_price,rew_price,rew_max,pro_phone,pro_tos)
		VALUES (#{mem_idx},#{cate_idx},#{pro_title},#{pro_content},#{pro_deadline},#{pro_startdate},#{rew_name},#{ori_price},#{rew_price},#{rew_max},#{pro_phone},#{pro_tos})
	</insert>
	
	<insert id="createMainPhoto">
		INSERT INTO photo(ref_idx, pho_name, pho_division)
		VALUES(#{param1},#{param2},#{param3})
	</insert>
	
	<insert id="createPhoto">
		INSERT INTO photo(ref_idx, pho_name, pho_division) 
		VALUES(#{param1},#{param2},#{param3})
	</insert>

	<insert id="funding" parameterType="map">
		insert into project_apply (pro_idx,mem_idx,rew_cnt,mile_use,total_price)
			values(#{pro_idx},#{mem_idx},#{rew_quantity},#{mileage},#{total_price})	
	</insert>
	
	<update id="moneyMng" parameterType="map">
		UPDATE `member` SET 
			mem_cash = (select mem_cash from member where mem_idx = #{mem_idx})-(#{total_price}-#{mileage}),
			mem_mileage = (select mem_mileage from member where mem_idx = #{mem_idx})-#{mileage}
		WHERE mem_idx = #{mem_idx}
	</update>
	
	<update id="fundingCancle" parameterType="map">
		update project_apply set
			fund_state = 'B' where pro_idx = #{pro_idx} and mem_idx = #{mem_idx};
	</update>
	
	<update id="moneyRefund" parameterType="map">
		UPDATE `member` SET 
			mem_cash = (select mem_cash from member where mem_idx = #{mem_idx})
									+(select total_price-mile_use from project_apply where mem_idx = #{mem_idx} and pro_idx = #{pro_idx} order by fund_idx desc limit 1),
			mem_mileage = (select mem_mileage from member where mem_idx = #{mem_idx})
										+(select mile_use from project_apply where mem_idx = #{mem_idx} and pro_idx = #{pro_idx} order by fund_idx desc limit 1)
		WHERE mem_idx = #{mem_idx};
	</update>
	
	<insert id="reviewDo" useGeneratedKeys="true" keyColumn="rev_idx" keyProperty="rev_idx" parameterType="com.uni.fund.project.dto.ProjectDTO">
		INSERT INTO project_review (pro_idx,mem_idx,rev_content,rev_grade,rev_state)
			VALUES (#{pro_idx},#{mem_idx},#{rev_content},#{rev_grade},'show')
	</insert>
	
	<insert id="revFileWrite">
		INSERT INTO photo (pho_name,ref_idx,pho_division)
			VALUES(#{param2},#{param1},'리뷰')
	</insert>
	
	<select id="revList" resultType="com.uni.fund.project.dto.ReviewDTO">
		select
			mem_idx as id, rev_idx, pro_idx, rev_content, rev_grade, rev_date, rev_state,pho_name,
			(select mem_id from `member` m where mem_idx = pr.mem_idx) as mem_id,
			(select pho_name from photo p2 where pho_division = '프로필' and ref_idx = id) as profile
		from 
			project_review pr 
		right join 
			photo p on pr.rev_idx = p.ref_idx 
		where pr.pro_idx = #{param1} and p.pho_division = '리뷰' and pr.rev_state = 'show' order by rev_date desc limit #{param2};
	</select>
	
	<update id="revDel">
		UPDATE project_review SET rev_state = 'blind' WHERE rev_idx = #{param1} 
	</update>
	
	<update id="mileageSaveUp">
		update member set mem_mileage = (select mem_mileage from member where mem_idx = #{param1}) + 5 where mem_idx = #{pram1}
	</update>
	
	<select id="appListCall" resultType="com.uni.fund.project.dto.ProjectDTO">
		select mem_id , CONCAT(mem_addr,' ',mem_detail) as mem_addr , mem_number
			from `member` m join project_apply pa on m.mem_idx = pa.mem_idx where pro_idx = 9 and fund_state = 'C' LIMIT #{param1},#{param2}
	</select>
	
	<select id="allCount" resultType="int">
		SELECT CEIL(COUNT(mem_id)/#{param1}) AS pages FROM `member` m join project_apply pa on m.mem_idx = pa.mem_idx where pro_idx = 9 and fund_state = 'C'
	</select>
	
	<insert id="likeDo" parameterType="String">
		insert into project_like(pro_idx,mem_idx)values(#{param1},#{param2})
	</insert>
	
	<delete id="likeCancle" parameterType="String">
		delete from project_like where pro_idx = #{param1} and mem_idx = #{param2}
	</delete>
	
	<insert id="favorite" parameterType="String">
		insert into bookmark(pro_idx,mem_idx)values(#{param1},#{param2})
	</insert>
	
	<delete id="favoriteCancle" parameterType="String">
		delete from bookmark where pro_idx = #{param1} and mem_idx = #{param2}
	</delete>
	
	<select id="adminList" resultType="com.uni.fund.project.dto.ProjectDTO">
		select 
		 	*,
		 	rew_price * rew_max  as target_price,
		 	(select round((pa.now_price/target_price) * 100)) as progress 
		from project p join (select pro_idx ,SUM(total_price)as now_price from project_apply  where fund_state = 'A' group by pro_idx) pa on p.pro_idx = pa.pro_idx;
	</select>
	
</mapper>