<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC   "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd"
>
<!-- 이 xml 은 어떤 interface 를 참조해서 사용해야 하는가? -->
<mapper namespace="com.uni.fund.project.dao.ProjectDAO">
	<select id="detail" resultType="com.uni.fund.project.dto.ProjectDTO">
		select
			* 	
			,(select cate_name from category 
				where 
					cate_idx = (select cate_idx from project where pro_idx = 7)) as category
			,(select mem_id from member where mem_idx = (select mem_idx from project where pro_idx = 7)) as userId
			,(select COUNT(pro_idx) from project_like where pro_idx = 7 group by pro_idx) as like_cnt
			,(select SUM(total_price) from project_apply where pro_idx = 7 group by pro_idx) as now_price
			,(select (rew_price * rew_max) from project p where pro_idx = 7) as target_price
			,(select mem_mileage from member where mem_idx = 1) as mileage
			,(select mem_cash from member where mem_idx = 1) as cash
			,(select mem_post from member where mem_idx =1) as mem_post 
			,(select mem_addr from member where mem_idx =1) as mem_addr 
			,(select mem_detail from member where mem_idx =1) as mem_detail
			,(select round((now_price/target_price) * 100)) as progress 
			,(select pho_name from photo where ref_idx = 7 and pho_division = '프로젝트') as pro_img_name
		from project where pro_idx = 7;
	</select>
	
	<insert id="projectCreate"
	useGeneratedKeys="true" 
	keyColumn="pro_idx" 
	keyProperty="pro_idx"
	parameterType= "com.uni.fund.project.dto.ProjectDTO">
	INSERT INTO project(mem_idx,cate_idx,pro_title,pro_content,pro_deadline,pro_startdate,rew_name,ori_price,rew_price,rew_max,pro_phone,pro_tos)
	VALUES (#{mem_idx},#{cate_idx},#{pro_title},#{pro_content},#{pro_deadline},#{pro_startdate},#{rew_name},#{ori_price},#{rew_price},#{rew_max},#{pro_phone},#{pro_tos})
	</insert>
	
	<insert id="createMainPhoto">
		INSERT INTO photo(ref_idx, pho_name, pho_division)
		VALUES(#{param1},#{param2},#{param3})
	</insert>
	
	<insert id="createPhoto">
		INSERT INTO photo(ref_idx, pho_name, pho_division) 
		VALUES(#{param1},#{param2},#{param3})
	</insert>
	
	<select id="updateForm" resultType="com.uni.fund.project.dto.ProjectDTO">
	SELECT 
    	j.mem_idx,
    	j.pro_title,
    	(SELECT p.pho_name FROM photo p WHERE p.pho_division = '프로젝트대표사진' AND pro_idx = j.pro_idx) as pro_main_name, 
    	j.pro_content, 
    	(SELECT p.pho_name FROM photo p WHERE p.pho_division = '프로젝트설명' AND pro_idx = j.pro_idx) as pro_img_name,
    	j.cate_idx, 
    	j.pro_phone,
    	j.rew_name,
    	j.ori_price,
    	j.rew_max,
    	j.rew_price,
    	j.pro_deadline,
    	j.pro_startdate,
    	j.pro_tos
	FROM 
    	project j
	WHERE 
    j.pro_idx = #{param1};
	</select>

</mapper>